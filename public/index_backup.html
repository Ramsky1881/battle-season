import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getFirestore, collection, doc, setDoc, onSnapshot,
  updateDoc, deleteDoc, query, orderBy, getDocs
} from 'firebase/firestore';
import {
  getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken
} from 'firebase/auth';
import {
  Trophy, Users, Zap, Hash, Activity, Lock, Unlock,
  Monitor, Settings, Crown, TrendingUp, AlertTriangle,
  Dices, ArrowRight, Shield, Swords
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// --- FIREBASE SETUP ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'xfive-battle';

// --- TYPES ---
type Player = {
  id: string;
  name: string;
  room: string; // "1"-"6", "A", "B", "FINAL"
  scores: number[]; // Array skor per game
  totalScore: number;
  status: 'active' | 'eliminated' | 'qualified';
  wheelEffect?: {
    type: 'REVERSE' | 'DOUBLE' | 'BOOM' | 'NONE';
    value: number; // e.g., 1.1 (10%), 2.0 (2x), 0.9 (-10%)
    desc: string;
  };
};

type AppState = {
  stage: 'QUALIFIERS_D1' | 'QUALIFIERS_D2' | 'SEMIFINALS' | 'FINALS';
  activeRoomViewer: string; // Room yang sedang dilihat viewer
};

// --- STYLES & THEME ---
const theme = {
  bg: "bg-[#0b0f1a]",
  card: "bg-[#111625] border border-cyan-900/50",
  text: "text-slate-200",
  heading: "font-orbitron tracking-widest",
  neonCyan: "shadow-[0_0_10px_#06b6d4] border-cyan-500 text-cyan-400",
  neonPurple: "shadow-[0_0_10px_#a855f7] border-purple-500 text-purple-400",
  neonPink: "shadow-[0_0_10px_#ec4899] border-pink-500 text-pink-400",
  neonGold: "shadow-[0_0_15px_#eab308] border-yellow-500 text-yellow-400",
};

// --- COMPONENTS ---

const GlitchText = ({ text, color = "text-cyan-400", size = "text-2xl" }: { text: string, color?: string, size?: string }) => (
  <div className={`relative inline-block ${theme.heading} ${size} ${color} group`}>
    <span className="relative z-10">{text}</span>
    <span className="absolute top-0 left-0 -ml-0.5 translate-x-[2px] text-red-500 opacity-70 animate-pulse hidden group-hover:block">{text}</span>
    <span className="absolute top-0 left-0 -ml-0.5 -translate-x-[2px] text-blue-500 opacity-70 animate-pulse delay-75 hidden group-hover:block">{text}</span>
  </div>
);

const NeonCard = ({ children, className = "", glow = "cyan" }: { children: React.ReactNode, className?: string, glow?: "cyan" | "purple" | "pink" | "none" }) => {
  let glowClass = "";
  if (glow === "cyan") glowClass = "hover:shadow-[0_0_15px_rgba(6,182,212,0.3)] border-cyan-900/50";
  if (glow === "purple") glowClass = "hover:shadow-[0_0_15px_rgba(168,85,247,0.3)] border-purple-900/50";
  if (glow === "pink") glowClass = "hover:shadow-[0_0_15px_rgba(236,72,153,0.3)] border-pink-900/50";

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      className={`relative overflow-hidden rounded-xl bg-[#131b2e] border ${glowClass} backdrop-blur-sm p-4 ${className}`}
    >
      <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-current to-transparent opacity-20" />
      {children}
    </motion.div>
  );
};

// --- MAIN APP ---

export default function App() {
  const [user, setUser] = useState<any>(null);
  const [isAdmin, setIsAdmin] = useState(false); // Toggle view
  const [players, setPlayers] = useState<Player[]>([]);
  const [appState, setAppState] = useState<AppState>({
    stage: 'QUALIFIERS_D1',
    activeRoomViewer: '1'
  });
  const [loading, setLoading] = useState(true);

  // Auth & Init
  useEffect(() => {
    const init = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Auth error", e);
      }
    };
    init();
    return onAuthStateChanged(auth, setUser);
  }, []);

  // Data Sync
  useEffect(() => {
    if (!user) return;

    // Listen to Players
    const qPlayers = query(collection(db, 'artifacts', appId, 'public', 'data', 'players'));
    const unsubPlayers = onSnapshot(qPlayers, (snapshot) => {
      const pData = snapshot.docs.map(d => d.data() as Player);
      setPlayers(pData);
      setLoading(false);
    });

    // Listen to App State
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
    const unsubState = onSnapshot(docRef, (snap) => {
      if (snap.exists()) {
        setAppState(snap.data() as AppState);
      } else if (isAdmin) {
        // Init default state if not exists
        setDoc(docRef, { stage: 'QUALIFIERS_D1', activeRoomViewer: '1' });
      }
    });

    return () => {
      unsubPlayers();
      unsubState();
    };
  }, [user, isAdmin]);

  // --- LOGIC HELPERS ---

  const calculateTotal = (player: Player) => {
    const rawScore = player.scores.reduce((a, b) => a + b, 0);
    let finalScore = rawScore;

    // Apply Wheel Effect logic for Semifinals/Finals visibility
    if (player.wheelEffect?.type === 'REVERSE') {
      // Logic handled in display usually, but here we can modify total for sorting
    } else if (player.wheelEffect?.type === 'BOOM') {
      if (player.wheelEffect.value !== 1) {
        // Add percentage or static value. Example: Percentage
        // finalScore = rawScore * player.wheelEffect.value;
        // Prompt says +15% or -10% score
        finalScore = Math.floor(rawScore * player.wheelEffect.value);
      }
    } else if (player.wheelEffect?.type === 'DOUBLE') {
      // Simplified: Assume double applies to raw total for demo simplicity
      // Or best score x2. Let's do Best Score x2 as per prompt
      if (player.scores.length > 0) {
        const max = Math.max(...player.scores);
        finalScore = rawScore + max; // Add max again (total = sum + max)
      }
    }

    return finalScore;
  };

  const getPlayersInRoom = (room: string) => {
    const roomPlayers = players.filter(p => p.room === room);
    // Sort by calculated total desc
    return roomPlayers.sort((a, b) => calculateTotal(b) - calculateTotal(a));
  };

  // --- ADMIN ACTIONS ---

  const addPlayer = async (name: string, room: string) => {
    const newPlayer: Player = {
      id: crypto.randomUUID(),
      name,
      room,
      scores: [],
      totalScore: 0,
      status: 'active'
    };
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', newPlayer.id), newPlayer);
  };

  const updateScore = async (playerId: string, gameIndex: number, score: number) => {
    const player = players.find(p => p.id === playerId);
    if (!player) return;

    const newScores = [...player.scores];
    newScores[gameIndex] = score;

    // Optimistic calculation for Firestore
    const dummyPlayer = { ...player, scores: newScores };
    const total = calculateTotal(dummyPlayer);

    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', playerId), {
      scores: newScores,
      totalScore: total
    });
  };

  const setStage = async (stage: AppState['stage']) => {
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), { stage });
  };

  const setViewerRoom = async (room: string) => {
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), { activeRoomViewer: room });
  };

  const runWheel = async (room: string) => {
    // Logic: Pick random players in room and apply effects
    const roomPlayers = getPlayersInRoom(room);
    if (roomPlayers.length === 0) return;

    // Reset effects first
    const batchPromises = roomPlayers.map(p =>
      updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', p.id), { wheelEffect: null })
    );
    await Promise.all(batchPromises);

    // Apply Random Logic
    // 1. Reverse Chance (Bottom ranks get bonus)
    // 2. Double Chance (1-2 random players get Best x2)
    // 3. Boom Chance (+15% or -10%)

    // Simple implementation: Randomly assign one effect type to the room logic
    const effectType = ['DOUBLE', 'BOOM'][Math.floor(Math.random() * 2)];

    const luckyIndex = Math.floor(Math.random() * roomPlayers.length);
    const luckyPlayer = roomPlayers[luckyIndex];

    let effectData: Player['wheelEffect'];

    if (effectType === 'DOUBLE') {
      effectData = { type: 'DOUBLE', value: 2, desc: 'DOUBLE CHANCE (Best x2)' };
    } else {
      const isGood = Math.random() > 0.4;
      if (isGood) effectData = { type: 'BOOM', value: 1.15, desc: 'BOOM (+15%)' };
      else effectData = { type: 'BOOM', value: 0.90, desc: 'BOOM (-10%)' };
    }

    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', luckyPlayer.id), {
      wheelEffect: effectData
    });

    // Also apply reverse chance statically to bottom rank
    const lastPlace = roomPlayers[roomPlayers.length - 1];
    if (lastPlace.id !== luckyPlayer.id) {
       await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', lastPlace.id), {
        wheelEffect: { type: 'REVERSE', value: 1.1, desc: 'REVERSE (+10%)' }
      });
    }
  };

  const advanceQualifiers = async (dayRooms: string[]) => {
    // Top 2 from each room advance
    for (const r of dayRooms) {
      const sorted = getPlayersInRoom(r);
      // Top 2
      for (let i = 0; i < 2; i++) {
        if (sorted[i]) {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', sorted[i].id), {
            status: 'qualified',
            // Simple logic: Room 1-3 -> A, 4-6 -> B. Or random.
            // Let's do: 1,2,3 -> A. 4,5,6 -> B.
            room: ['1','2','3'].includes(r) ? 'A' : 'B',
            scores: [], // Reset scores
            totalScore: 0,
            wheelEffect: null
          });
        }
      }
      // Others eliminated
      for (let i = 2; i < sorted.length; i++) {
        if (sorted[i]) {
           await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', sorted[i].id), {
            status: 'eliminated'
          });
        }
      }
    }
  };

  const advanceSemis = async () => {
    // Top 3 from A and B advance to FINAL
    for (const r of ['A', 'B']) {
      const sorted = getPlayersInRoom(r);
      for (let i = 0; i < 3; i++) {
        if (sorted[i]) {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', sorted[i].id), {
            status: 'qualified',
            room: 'FINAL',
            scores: [],
            totalScore: 0,
            wheelEffect: null
          });
        }
      }
      for (let i = 3; i < sorted.length; i++) {
        if (sorted[i]) {
           await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', sorted[i].id), {
            status: 'eliminated'
          });
        }
      }
    }
    setStage('FINALS');
  };

  // --- VIEWS ---

  if (loading) return <div className="min-h-screen bg-black flex items-center justify-center text-cyan-500 font-orbitron animate-pulse">SYSTEM INITIALIZING...</div>;

  return (
    <div className={`min-h-screen ${theme.bg} ${theme.text} font-sans selection:bg-cyan-500 selection:text-black overflow-x-hidden`}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@400;700;900&family=Oxanium:wght@400;600;800&display=swap');
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .font-oxanium { font-family: 'Oxanium', sans-serif; }
        .grid-bg {
          background-size: 40px 40px;
          background-image: linear-gradient(to right, rgba(6, 182, 212, 0.05) 1px, transparent 1px),
                            linear-gradient(to bottom, rgba(6, 182, 212, 0.05) 1px, transparent 1px);
        }
        .scanline {
          background: linear-gradient(to bottom, transparent, rgba(6, 182, 212, 0.1), transparent);
          animation: scan 4s linear infinite;
        }
        @keyframes scan { from { transform: translateY(-100%); } to { transform: translateY(100vh); } }
      `}</style>

      {/* BACKGROUND EFFECTS */}
      <div className="fixed inset-0 grid-bg pointer-events-none z-0" />
      <div className="fixed inset-0 pointer-events-none z-0 bg-gradient-to-b from-transparent via-transparent to-[#0b0f1a]" />
      <div className="fixed w-full h-2 scanline pointer-events-none z-0" />

      {/* NAVBAR / TOGGLE */}
      <nav className="relative z-50 flex justify-between items-center p-4 border-b border-cyan-900/50 bg-[#0b0f1a]/80 backdrop-blur">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-cyan-900/20 rounded flex items-center justify-center border border-cyan-500 shadow-[0_0_10px_#06b6d4]">
            <Swords className="text-cyan-400" />
          </div>
          <div>
            <h1 className={`${theme.heading} text-xl text-white`}>XFIVE <span className="text-cyan-400">BATTLE</span></h1>
            <p className="text-xs text-slate-500 font-oxanium tracking-widest">SEASON TOURNAMENT</p>
          </div>
        </div>
        <div className="flex gap-4">
          <button
            onClick={() => setIsAdmin(!isAdmin)}
            className={`px-4 py-1 rounded border font-oxanium text-sm transition-all ${isAdmin ? 'bg-red-900/20 border-red-500 text-red-400' : 'bg-cyan-900/20 border-cyan-500 text-cyan-400'}`}
          >
            {isAdmin ? 'ADMIN MODE' : 'VIEWER MODE'}
          </button>
        </div>
      </nav>

      {/* CONTENT */}
      <main className="relative z-10 p-4 md:p-6 max-w-7xl mx-auto">
        {isAdmin ? (
          <AdminDashboard
            players={players}
            appState={appState}
            setStage={setStage}
            addPlayer={addPlayer}
            updateScore={updateScore}
            runWheel={runWheel}
            advanceQualifiers={advanceQualifiers}
            advanceSemis={advanceSemis}
            setViewerRoom={setViewerRoom}
          />
        ) : (
          <ViewerMode
            players={players}
            appState={appState}
            getPlayersInRoom={getPlayersInRoom}
          />
        )}
      </main>
    </div>
  );
}

// ----------------------------------------------------------------------
// ADMIN DASHBOARD COMPONENT
// ----------------------------------------------------------------------

const AdminDashboard = ({
  players, appState, setStage, addPlayer, updateScore, runWheel, advanceQualifiers, advanceSemis, setViewerRoom
}: any) => {
  const [activeTab, setActiveTab] = useState('manage');
  const [newPlayerName, setNewPlayerName] = useState('');
  const [newPlayerRoom, setNewPlayerRoom] = useState('1');

  // Group players by room for display
  const rooms = ['1', '2', '3', '4', '5', '6', 'A', 'B', 'FINAL'];

  return (
    <div className="space-y-6">
      {/* CONTROL PANEL */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <NeonCard className="md:col-span-3">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-orbitron text-cyan-400 flex items-center gap-2"><Settings size={18} /> TOURNAMENT CONTROLS</h2>
            <div className="flex gap-2">
               {['QUALIFIERS_D1', 'QUALIFIERS_D2', 'SEMIFINALS', 'FINALS'].map(s => (
                 <button
                   key={s}
                   onClick={() => setStage(s)}
                   className={`px-3 py-1 text-xs border rounded ${appState.stage === s ? 'bg-cyan-500 text-black border-cyan-500 font-bold' : 'border-slate-700 text-slate-500'}`}
                 >
                   {s.replace('_', ' ')}
                 </button>
               ))}
            </div>
          </div>
          <div className="flex flex-wrap gap-4">
            <button onClick={() => advanceQualifiers(['1','2','3'])} className="px-4 py-2 bg-purple-900/30 border border-purple-500 text-purple-300 rounded hover:bg-purple-800/50 text-xs font-oxanium">
              AUTO-QUALIFY DAY 1 (Rooms 1-3)
            </button>
            <button onClick={() => advanceQualifiers(['4','5','6'])} className="px-4 py-2 bg-purple-900/30 border border-purple-500 text-purple-300 rounded hover:bg-purple-800/50 text-xs font-oxanium">
              AUTO-QUALIFY DAY 2 (Rooms 4-6)
            </button>
            <button onClick={() => advanceSemis()} className="px-4 py-2 bg-pink-900/30 border border-pink-500 text-pink-300 rounded hover:bg-pink-800/50 text-xs font-oxanium">
              FINISH SEMIS &rarr; FINAL
            </button>
          </div>
        </NeonCard>

        <NeonCard>
          <h2 className="text-lg font-orbitron text-white mb-2 flex items-center gap-2"><Monitor size={18} /> VIEWER ROOM</h2>
          <select
            value={appState.activeRoomViewer}
            onChange={(e) => setViewerRoom(e.target.value)}
            className="w-full bg-slate-900 border border-slate-700 text-white p-2 rounded focus:border-cyan-500 outline-none"
          >
            {rooms.map(r => <option key={r} value={r}>Room {r}</option>)}
          </select>
          <div className="mt-4 text-xs text-slate-400">
            Select which room is currently displayed on the big screen (Viewer Mode).
          </div>
        </NeonCard>
      </div>

      {/* INPUTS AREA */}
      <div className="flex gap-4 border-b border-slate-800 pb-2 overflow-x-auto">
        <button onClick={() => setActiveTab('manage')} className={`px-4 py-2 font-oxanium ${activeTab === 'manage' ? 'text-cyan-400 border-b-2 border-cyan-400' : 'text-slate-500'}`}>MANAGE PLAYERS</button>
        <button onClick={() => setActiveTab('score')} className={`px-4 py-2 font-oxanium ${activeTab === 'score' ? 'text-cyan-400 border-b-2 border-cyan-400' : 'text-slate-500'}`}>SCORING</button>
        <button onClick={() => setActiveTab('wheel')} className={`px-4 py-2 font-oxanium ${activeTab === 'wheel' ? 'text-purple-400 border-b-2 border-purple-400' : 'text-slate-500'}`}>SPIN WHEEL</button>
      </div>

      {activeTab === 'manage' && (
        <NeonCard>
          <div className="flex gap-4 mb-6 items-end">
            <div>
              <label className="text-xs text-slate-400">Player Name</label>
              <input
                type="text"
                value={newPlayerName}
                onChange={e => setNewPlayerName(e.target.value)}
                className="block w-48 bg-slate-900 border border-slate-700 p-2 text-white rounded mt-1"
                placeholder="Nickname"
              />
            </div>
            <div>
              <label className="text-xs text-slate-400">Assign Room</label>
              <select
                value={newPlayerRoom}
                onChange={e => setNewPlayerRoom(e.target.value)}
                className="block w-24 bg-slate-900 border border-slate-700 p-2 text-white rounded mt-1"
              >
                {rooms.map(r => <option key={r} value={r}>{r}</option>)}
              </select>
            </div>
            <button
              onClick={() => {
                if(newPlayerName) {
                  addPlayer(newPlayerName, newPlayerRoom);
                  setNewPlayerName('');
                }
              }}
              className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded flex items-center gap-2"
            >
              <Users size={16} /> ADD
            </button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {players.map((p: any) => (
              <div key={p.id} className="flex justify-between items-center bg-slate-900 p-3 rounded border border-slate-800">
                <div>
                  <div className="font-bold text-white">{p.name}</div>
                  <div className="text-xs text-cyan-500">Room {p.room} â€¢ {p.status}</div>
                </div>
                <div className="text-xl font-oxanium text-slate-400">{p.totalScore}</div>
              </div>
            ))}
          </div>
        </NeonCard>
      )}

      {activeTab === 'score' && (
        <div className="space-y-8">
          {rooms.map(room => {
            const roomPlayers = players.filter((p: any) => p.room === room && p.status !== 'eliminated');
            if (roomPlayers.length === 0) return null;

            return (
              <div key={room}>
                <h3 className="text-xl font-orbitron text-cyan-400 mb-4 border-l-4 border-cyan-500 pl-3">ROOM {room}</h3>
                <div className="overflow-x-auto">
                  <table className="w-full text-left border-collapse">
                    <thead>
                      <tr className="border-b border-slate-700 text-slate-400 font-oxanium text-sm">
                        <th className="p-3">PLAYER</th>
                        {[1, 2, 3, 4, 5].map(i => <th key={i} className="p-3">GAME {i}</th>)}
                        <th className="p-3 text-right">TOTAL</th>
                      </tr>
                    </thead>
                    <tbody>
                      {roomPlayers.map((p: any) => (
                        <tr key={p.id} className="border-b border-slate-800 hover:bg-slate-800/30">
                          <td className="p-3 font-bold text-white">{p.name}</td>
                          {[0, 1, 2, 3, 4].map(idx => (
                            <td key={idx} className="p-3">
                              <input
                                type="number"
                                className="w-16 bg-black/30 border border-slate-700 p-1 text-center text-cyan-300 rounded focus:border-cyan-500 outline-none"
                                value={p.scores[idx] || ''}
                                onChange={(e) => updateScore(p.id, idx, parseInt(e.target.value) || 0)}
                                placeholder="-"
                              />
                            </td>
                          ))}
                          <td className="p-3 text-right font-oxanium text-xl text-yellow-400">{p.totalScore}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {activeTab === 'wheel' && (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <NeonCard glow="purple">
            <h3 className="text-xl font-orbitron text-purple-400 mb-4">WHEEL CONTROLLER (SEMIS)</h3>
            <p className="text-sm text-slate-400 mb-6">Triggering the wheel will randomly assign Reverse, Double, or Boom chance effects to players in the selected room.</p>

            <div className="flex gap-4">
              <button onClick={() => runWheel('A')} className="flex-1 py-4 bg-purple-900/40 border border-purple-500 rounded hover:bg-purple-800/60 text-white font-bold font-orbitron flex flex-col items-center gap-2">
                <Dices size={24} /> SPIN ROOM A
              </button>
              <button onClick={() => runWheel('B')} className="flex-1 py-4 bg-purple-900/40 border border-purple-500 rounded hover:bg-purple-800/60 text-white font-bold font-orbitron flex flex-col items-center gap-2">
                <Dices size={24} /> SPIN ROOM B
              </button>
            </div>
          </NeonCard>

          <div className="space-y-2">
            <h4 className="text-slate-400 font-oxanium">ACTIVE EFFECTS</h4>
            {players.filter((p:any) => p.wheelEffect).map((p:any) => (
              <div key={p.id} className="flex justify-between items-center bg-purple-900/20 border border-purple-500/30 p-3 rounded">
                <span className="text-white font-bold">{p.name}</span>
                <span className="text-purple-300 text-sm font-oxanium">{p.wheelEffect?.desc}</span>
              </div>
            ))}
            {players.filter((p:any) => p.wheelEffect).length === 0 && (
              <div className="text-slate-600 italic">No active wheel effects.</div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

// ----------------------------------------------------------------------
// VIEWER MODE COMPONENT
// ----------------------------------------------------------------------

const ViewerMode = ({ players, appState, getPlayersInRoom }: any) => {
  // Use the active room set by admin, or default logic based on stage
  const room = appState.activeRoomViewer;
  const roomPlayers = getPlayersInRoom(room);

  // Determine Qualification Count
  const qualifyCount = appState.stage === 'FINALS' ? 3 : (['A', 'B'].includes(room) ? 3 : 2);

  return (
    <div className="max-w-6xl mx-auto">
      {/* HEADER STATS */}
      <div className="flex justify-between items-end mb-8 border-b border-cyan-900/30 pb-4">
        <div>
           <div className="flex items-center gap-2 text-cyan-500 mb-1">
             <Activity className="animate-pulse" size={16} /> LIVE DATA
           </div>
           <GlitchText text={`ROOM ${room}`} size="text-5xl" />
           <div className="text-purple-400 font-oxanium text-lg mt-1 tracking-widest">{appState.stage.replace('_', ' ')}</div>
        </div>
        <div className="text-right hidden md:block">
           <div className="text-xs text-slate-500 font-oxanium">TOTAL PLAYERS</div>
           <div className="text-2xl text-white font-bold">{roomPlayers.length}</div>
        </div>
      </div>

      {/* LEADERBOARD GRID */}
      <div className="grid grid-cols-1 gap-4">
        <AnimatePresence>
          {roomPlayers.map((player: Player, index: number) => {
            const isQualifying = index < qualifyCount;
            const rank = index + 1;

            return (
              <motion.div
                key={player.id}
                layout
                initial={{ opacity: 0, x: -50 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, scale: 0.9 }}
                transition={{ duration: 0.5 }}
              >
                <div className={`
                  relative flex items-center justify-between p-4 md:p-6 rounded-r-xl border-l-4
                  backdrop-blur-md transition-all duration-300
                  ${isQualifying
                    ? 'bg-gradient-to-r from-cyan-900/40 to-transparent border-cyan-400 shadow-[0_0_20px_rgba(6,182,212,0.1)]'
                    : 'bg-slate-900/40 border-slate-700 grayscale-[0.5]'}
                `}>

                  {/* Rank & Name */}
                  <div className="flex items-center gap-6">
                    <div className={`
                      w-12 h-12 flex items-center justify-center font-orbitron text-2xl font-bold rounded
                      ${rank === 1 ? 'text-yellow-400 bg-yellow-900/20 border border-yellow-500' :
                        rank === 2 ? 'text-slate-300 bg-slate-700/30 border border-slate-500' :
                        rank === 3 ? 'text-orange-400 bg-orange-900/20 border border-orange-600' : 'text-slate-600'}
                    `}>
                      {rank}
                    </div>

                    <div>
                      <h3 className={`font-bold text-xl md:text-3xl font-orbitron tracking-wide ${isQualifying ? 'text-white' : 'text-slate-500'}`}>
                        {player.name}
                      </h3>
                      {/* Wheel Effect Badge */}
                      {player.wheelEffect && (
                         <motion.div
                           initial={{ scale: 0 }} animate={{ scale: 1 }}
                           className="inline-flex items-center gap-1 mt-1 px-2 py-0.5 rounded bg-purple-900/50 border border-purple-500 text-purple-300 text-xs font-oxanium"
                         >
                           <Zap size={12} /> {player.wheelEffect.desc}
                         </motion.div>
                      )}
                    </div>
                  </div>

                  {/* Scores */}
                  <div className="flex items-center gap-8">
                    {/* Game History (Desktop only) */}
                    <div className="hidden md:flex gap-2">
                       {player.scores.map((s, i) => (
                         <div key={i} className="flex flex-col items-center">
                           <span className="text-[10px] text-slate-600">G{i+1}</span>
                           <span className="text-slate-400 font-mono text-sm">{s}</span>
                         </div>
                       ))}
                    </div>

                    {/* Total Score */}
                    <div className="text-right min-w-[100px]">
                      <div className="text-xs text-slate-500 font-oxanium mb-1">TOTAL PTS</div>
                      <div className={`text-3xl md:text-4xl font-oxanium font-bold ${isQualifying ? 'text-cyan-400' : 'text-slate-600'}`}>
                        {player.totalScore}
                      </div>
                    </div>

                    {/* Status Indicator */}
                    <div className="w-10 flex justify-center">
                       {isQualifying ? (
                         <div className="p-2 rounded-full bg-cyan-500/20 text-cyan-400 shadow-[0_0_10px_#06b6d4] animate-pulse">
                           <ArrowRight size={24} />
                         </div>
                       ) : (
                         <div className="p-2 rounded-full bg-red-900/10 text-red-900">
                           <Lock size={24} />
                         </div>
                       )}
                    </div>
                  </div>
                </div>
              </motion.div>
            );
          })}
        </AnimatePresence>

        {roomPlayers.length === 0 && (
          <div className="text-center py-20 border border-dashed border-slate-800 rounded-xl">
            <h3 className="text-slate-500 font-orbitron text-xl">WAITING FOR DATA...</h3>
          </div>
        )}
      </div>

      {/* FOOTER ANIMATION (DECORATIVE) */}
      <div className="fixed bottom-0 left-0 w-full h-32 bg-gradient-to-t from-black to-transparent pointer-events-none z-20 flex items-end justify-center pb-4">
        {appState.stage === 'FINALS' && (
           <div className="flex gap-4 items-center animate-bounce text-yellow-500 font-orbitron text-sm">
              <Crown size={16} /> FINAL BATTLE IN PROGRESS <Crown size={16} />
           </div>
        )}
      </div>
    </div>
  );
};